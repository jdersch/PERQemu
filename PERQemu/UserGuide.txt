PERQemu User Guide (rough notes)

----

All of this culled from the Readme.  Fashion it into something coherent and
decide on a format to use to produce a nicely formatted document.  It would be
extra kewl to do it on the PERQ in Prose or Mint or Scribe. :-)

Or just bash it out in Google Docs and make it publicly readable or upload a
PDF?  Sigh.

----


To load a disk image, type "load harddisk" or "load floppy" followed by a
pathname to the image file.  Use the pathname syntax appropriate for your
platform.  (You can boot from a POS "boot floppy" but as on the real hardware,
floppy boots are slow!)  PERQemu will report "Loaded." if the disk image file
is read in successfully.

The PERQ could boot from several sources, or use different boots from one
hard disk image.  Lower case letters select a normal hard disk boot; upper
case letters select the floppy.  You can boot the "old fashioned way" by
waiting for the VFY patterns to appear and hitting the appropriate key, or
tell PERQemu to do it for you by typing "set bootchar <c>" where <c> is the
boot you wish to select.  The default boot letter is 'a'.

Hit "g" or type "go" and hit enter and the emulation will be off and running!
A large display window will appear, and soon you should see a strange set of
comb-like patterns displayed as the microcode runs through its memory tests
and other diagnostics.

Note that the PERQ display is a fixed 768 x 1024 in a portrait orientation
and PERQemu does not decorate the window with scroll bars or support any
full-screen modes.  The mouse wheel or the PgUp/PgDn keys may be used to jump
the PERQ display up or down if it doesn't fit your display.

2.1 Booting and the DDS
-----------------------

The debugger console window's title will read "DDS" followed by a three-digit
number:  this is the PERQ's "diagnostic display," where the progress of the
boot sequence may be monitored.  Note that the DDS is specific to the operating
system being booted!  When the boot is complete, the DDS will typically show:

    PNX:    255
    POS:    999
    Accent: 400 (1MB of memory) or 450 (2MB)

The PERQ does its best to fool you into thinking it's broken, showing wierd
noise or patterns on the screen until it finally enables the video interrupt
and the OS takes over the display.  Because we don't emulate the 2-3 minute
"warm-up" time that the old Shugart hard drives required, most hard disk boots
will complete in just a few seconds.  If your PERQ really is stuck, consult
the "Fault Dictionary" in the Bitsavers on-line documentation repository (see
below) or in the PERQemu source Docs directory on GitHub.




2.2 POS
-------

Once POS has booted, enter the date and login with user "guest" and a blank
password (or alternately just hit "enter" at the login prompt.)  You'll need
to put focus on the display window (click on it) so that the keyboard input
goes to the PERQ and not the debugger.

The mouse works approximately as you'd expect with one minor difference, due
to functional differences between a digitizer tablet and a mouse.  Specifically:
a digitizer knows when the puck is off the tablet, where a mouse does not.
Normally this is not an issue, but if you need to simulate the "off the tablet"
behavior, hold down the "Alt" key (Command key on the Mac).

Full POS documentation can be found on Bitsavers at

    http://www.bitsavers.org/pdf/perq/PERQ_SysSWRefManual_Feb1982.pdf
    
(also in sys:user>doc> in the F.1 hard disk image, or :boot>docs> in F.15)
    
Interaction with POS is through the command-line interpreter called the
Shell.  Here are some basic commands to get you started:

    ? - list the commands defined in your "login profile"

    HELP - shows usage for various commands

    DIR - show contents of the current directory.  Executable files are
        suffixed with ".RUN" and directories are suffixed with ".DR".

    PATH (or CD) - change directory.  More or less like your Unix or DOS
        equivalent.  Note that the directory delimiter is ">" (this may
        freak out Unix heads! :-)
        CD foo>bar>baz> - change to directory foo>bar>baz
        CD ..           - change to parent directory
        CD sys:user>    - change to root of user partition

    TYPE - display a file on the screen, similar to "more" on modern OSes.
            
    COMPILE - run the Pascal compiler.  Produces a .SEG file which must be
        linked.

    LINK - runs the linker.  Produces a ".RUN" file which may be executed.

    COPY - copies a file from one location to another.  RSX: is a special
        file which can be used to transfer files to/from the emulator host
        machine.  See section 3.0 for more details.

    EDITOR - a fairly simple text editor (see also PEPPER, a more Emacs-like
        editor, available in most of the POS images)

Executable files end with ".RUN", just type the name (minus .RUN) to start
them.  Switches are prefaced by '/' as in most OSes of the day.  Commands
and switches are not generally case-sensitive, and can usually be abbreviated
as long as they are not ambiguous.  Most commands in POS will prompt you for
arguments if you don't provide them, and most commands won't do anything
harmful without asking you first.

In general, "Ctrl+c" twice will abort a running program, unless it's hung.

Note that control characters on the PERQ are actually case-sensitive!  A single
Ctrl-c is an interrupt; a second Ctrl-c signals an abort.  A Ctrl-Shift-C is
used to break out of command files and return you to the Shell.  The Pepper
editor makes extensive use of shifted control characters to make up for the
lack of a "meta" key that Emacs requires.  Quirky, no?

There are games under sys:user>games>, demos under sys:user>demo>, various 
utilities and OS source are under sys:boot>.  There are user directories 
(from the original users of this machine at Siemens!) under sys:>user> in the 
D.6 image that contain some interesting utilities.  Things are arranged a
little bit differently in POS F.15; "type welcome.txt" to learn more when you
first log in.

You can log out of POS by typing "bye" to the Shell.  To log out and power
down, type "bye off" or "bye /off" and POS will tidy up and power off the
machine.  In the case of PERQemu, that means returning you to the debugger.
Note that after the emulated PERQ powers itself off you must type "reset" to
reboot it.

REMEMBER:  PERQemu does not save modifications to the hard or floppy disks
automatically; if you accidentally blow up the disk image, just exit and
restart or reload the image - no harm done!  If you DO want to save your
changes, type "save harddisk <filename>" or "save floppy <filename>" before
you exit.


2.3 Accent
----------

In the included D.6 disk image, an early release of the Accent OS from CMU
is available too.  Accent is the forerunner of Mach, the kernel which was
the basis for NeXTstep, which became MacOS X.  This version, S4, is an
amazing and rare find, as it pre-dates the official S5 and S6 releases from
Three Rivers/PERQ Systems in late 1984-early 1985.

To boot Accent, either type "set bootchar z" or wait for the DDS to read 151
and hit the z key.  Accent's startup sequence is different, and this early
version of Accent isn't nearly as fast as POS; after prompting you to enter
the date and time, starting the servers, starting up the window manager and
running through all the initial command files takes a bit longer.  But once
things are initialized, Accent's shell behaves very much like the POS Shell,
with most of the same commands -- and a few exceptions:

    - windows act more like folks today expect them to, though it's a bit
      clumsy manipulating them at first
    - you have to click to select a "listener" window to direct where your
      typing will go -- the listener window has a grey border around it
    - you can use the basic Emacs-like control keys to retrieve previously
      typed commands and edit them (^p/^n for previous/next, ^f/^b forward/
      back, etc)
    - you can scroll back to see text that scrolled off the screen (^V/^v
      for backward/forward by roughly a page full of text)
    - interrupting or aborting the current program goes through the window
      manager, so ^c or ^C doesn't work as in POS

SAPPHIRE, the window manager, has a bunch of commands and some on-line help.
All window manager commands are prefixed by Ctrl-Del, then a letter.  Until
you're familiar with it, Ctrl-Del h for help brings up a command summary.
There are also pop-up menus, and the icons change depending on what SAPPHIRE
wants you to do (make a window, move a window, etc).  To interrupt a program
in Accent, use Ctrl-Del c, or Ctrl-Del k for added oomph.

Note that the mouse in Accent is in relative mode, which is awkward to emulate
with a mouse; you can hold the "off tablet" key (Windows: Alt, Mac: Command)
and relocate the host's mouse, then release.  The PERQ will compute relative
movement based on the direction of the next swipe, not the absolute coordinates
in the window.  You'll catch on with a few tries. :-)

Button, button, who's got the button?  Accent S4 only enables the 4-button
BitPad puck, though it maps the buttons to match the 3-button Kriz puck.  If
you have a 3-button mouse, left-middle-right should be mapped appropriately.
For a two-button mouse, Ctrl-Left simulates the third button; Ctrl-Right
simulates the fourth PERQ button.  If you are using an old one-button Apple
mouse, I just don't know what to tell ya...

There is no clean way to log out of Accent, so the best way to make sure you
flush buffers to disk (if you want to save your work) is to type "trap" at
the Shell.  This will bring up the kernel debugger which will scribble in
reverse video all over your screen.  From there type 'y' to exit to the pager
process, and at that point there's no going back; switch to the PERQemu
debugger window and hit Ctrl-c to stop execution, save or reset as desired.



2.4 PNX
-------

Unfortunately, we do not yet have a complete PNX 1.0 hard disk image.  It is
possible to boot from floppy, prepare the hard disk, and lay down the boot-
strap (essentially a "miniroot" in Unix parlance) which is bootable.  But the
other floppies in the Bitsavers collection are missing track 0, and the rest
of the PNX loading process cannot be completed at this time.  I hope to remedy
this very soon.

PNX, another unfortunately named PERQ operating system, was a very early Unix
V7/System III mashup that included an in-kernel window manager - possibly one
of the first Unix variants to do so.  This was primarily run on PERQs in the
UK, where PNX was developed by ICL.  Because the on-disk format is based on
the Unix filesystem, it cannot co-reside on a disk with POS or Accent (which
share a common underlying filesystem layout).  PNX also used its own language
interpreter, running an instruction set more favorable to C than the original
PERQ Q-codes.  However, PERQemu's debugger cannot accurately disassemble PNX
C-codes, since we don't currently have access to any PNX source code or
documentation.

Watch this space.



3.0 Command Line Operations
===========================

Hit Ctrl+C when the debugger window has focus to break into the debugger at any 
time.  Hit "Tab" to see a list of command completions.  You do not need to type 
in an entire command to run it, only enough to disambiguate it from other
commands.  For example "l h" is short for "load harddisk" and "d m" is short
for "disassemble microcode".

"Tab" will always show completions at any point during input.  For example,
if you type "show" and hit tab, you will be presented with a list of possible
completions for the "show" command.  Commands are not case-sensitive, though
arguments may be (such as filenames, if your filesystem respects case).

The debugger is a work-in-progress and some commands may be unintuitive or
unfinished.  The more useful (and implemented) ones are:

    GO - begins emulation execution from the current microcode PC.

    RESET - resets the virtual PERQ.  Disk images are NOT reloaded, which makes
        this useful for rebooting the PERQ when installing an OS, for example.

    SET BOOTCHAR <char> - helper to make it easier to boot from an alternate
        boot.  The D.6 image has two available boots: 'a' and 'z'.  'a' is the
        default (POS), 'z' is Accent S4.                   

    LOAD FLOPPY/HARDDISK <image> - loads a given hard disk or floppy image into
        memory.
                     
    SAVE FLOPPY/HARDDISK <image> - saves the current in-memory hard disk or
        floppy to the specified image file.
                     
    CREATE FLOPPY/HARDDISK - creates a blank disk image in memory.

    SAVE SCREENSHOT <name> - saves a JPEG image of the current PERQ display.

    SET RS232 <port name> - selects the serial port on the host machine to use
        for the emulated PERQ.  "RSX:" is a special port which allows transfer
        of files to/from the emulation host.  If RSX: is selected as the port,
        from POS one can "COPY RSX:c:\path\to\hostfile.pas sys:foo>bar>baz.pas"
        and the file will be copied from the host OS to the emulated PERQ; this
        works for text (7-bit ASCII) only.  (It's also quite slow, since it has
        to run at serial speeds).

In the Debug build, there are a huge number of additional commands to inspect
the state of the emulator and assist with debugging PERQ microcode.  These
are not yet documented.


[is this in the readme-source?]

  Though the Kriz tablets were rarely connected to a PERQ-1, they were supported
  and are FAR more efficient for the OS to handle than the BitPadOne's ASCII-
  serial data format so we enable them by default.  Note that Accent S4 only
  uses the GPIB tablet; PNX is untried at this point.  In POS F, you can choose
  which one to use with a switch to LOGIN (or in your login profile):
        LOGIN /TABLETTYPE=BITPAD    selects GPIB
        LOGIN /TABLETTYPE=TABLET    selects Kriz
  In the updated DETAILS program included with POS F.15, you can see which one
  is active for your current session by typing "DETAILS /ALL".
    



3.1 Disk Operations
-------------------

The basic thing to bear in mind when dealing with PERQemu and disk images is
that PERQemu only makes changes to in-memory copies of the images.  That is:
if you make changes to the disk, you must MANUALLY dump the image back to an
image file when you are done or your changes WILL BE LOST when you exit the 
emulator or load another image.

Floppy disk images must be in RAW format (I am working on implementing DMK
support).

Hard disk images are in my extremely primitive dump format (which I intend
to improve and document).  Currently only images of the 24mb Shugart drive are
supported (mostly because I have so few images of other disks to work with...)

To load a disk image, use the LOAD FLOPPY/LOAD HARDDISK command from the 
debugger.

To save a disk image, use the SAVE FLOPPY/SAVE HARDDISK command (go figure).
You (currently) have to specify the pathname each time you save.

To create a blank disk, use the CREATE FLOPPY/CREATE HARDDISK command.  This
creates a blank, in-memory image of a disk.  You MUST save this image if you
want to use it again.

Note that in the current builds, disks are way, way faster than the actual
hardware, so it's less of a chore to format a floppy or partition a Shugart
hard disk than IRL.  Maybe in future releases we'll offer the 100% authentic
83ms access times and the kerchunk-kerchunk-kachunk audio clips of the SA851
floppy drive banging away on floppy boots... :-)


--

2/15/2022 - skeezicsb - v0.5.0 (experimental)
